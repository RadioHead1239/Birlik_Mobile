@page "/cliente/facturas"
@inject NavigationManager Nav

<div class="page-container">
    <div class="header-section animate-enter">
        <button class="btn-icon-back" @onclick='() => Nav.NavigateTo("/cliente/dashboard")'>
            <i class="bi bi-chevron-left"></i>
        </button>
        <h1>Mis Facturas</h1>
    </div>

    <!-- Summary Cards -->
    <div class="summary-scroll animate-enter" style="animation-delay: 0.1s">
        <div class="summary-card glass-panel">
            <span class="summary-label">Total Pendiente</span>
            <span class="summary-value">₡@GetTotalPendiente().ToString("N0")</span>
        </div>
        <div class="summary-card glass-panel">
            <span class="summary-label">Próximo Vencimiento</span>
            <span class="summary-value">@GetProximoVencimiento()</span>
        </div>
    </div>

    <!-- Filters -->
    <div class="filter-scroll animate-enter" style="animation-delay: 0.2s">
        <button class="filter-pill @(selectedFilter == "todas" ? "active" : "")" 
                @onclick='() => selectedFilter = "todas"'>Todas</button>
        <button class="filter-pill @(selectedFilter == "pendientes" ? "active" : "")" 
                @onclick='() => selectedFilter = "pendientes"'>Pendientes</button>
        <button class="filter-pill @(selectedFilter == "pagadas" ? "active" : "")" 
                @onclick='() => selectedFilter = "pagadas"'>Pagadas</button>
    </div>

    <!-- Invoice List -->
    <div class="invoice-list animate-enter" style="animation-delay: 0.3s">
        @foreach (var factura in GetFilteredFacturas())
        {
            <div class="invoice-card glass-panel">
                <div class="card-row">
                    <div class="invoice-icon @(factura.Estado == "Pagada" ? "success" : "warning")">
                        <i class="bi @(factura.Estado == "Pagada" ? "bi-check-lg" : "bi-clock")"></i>
                    </div>
                    <div class="invoice-info">
                        <h4>@factura.Poliza</h4>
                        <p>#@factura.Numero</p>
                    </div>
                    <div class="invoice-amount">
                        <span>₡@factura.Monto.ToString("N0")</span>
                        <small class="@GetStatusClass(factura.Estado)">@factura.Estado</small>
                    </div>
                </div>
                
                <div class="card-actions">
                    <span class="date">Vence: @factura.FechaVencimiento.ToString("dd MMM")</span>
                    <button class="btn-icon-sm" @onclick="() => DescargarFactura(factura.Id)">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private string selectedFilter = "todas";
    
    // Mock Data
    private List<FacturaInfo> facturas = new()
    {
        new FacturaInfo { Id=1, Numero="FAC-001", Poliza="Vida Premium", Estado="Pendiente", Monto=45000, FechaVencimiento=DateTime.Now.AddDays(5) },
        new FacturaInfo { Id=2, Numero="FAC-002", Poliza="Auto Total", Estado="Pagada", Monto=85000, FechaVencimiento=DateTime.Now.AddMonths(-1) },
        new FacturaInfo { Id=3, Numero="FAC-003", Poliza="Hogar Seguro", Estado="Vencida", Monto=25000, FechaVencimiento=DateTime.Now.AddDays(-5) }
    };

    private IEnumerable<FacturaInfo> GetFilteredFacturas()
    {
        return selectedFilter switch
        {
            "pagadas" => facturas.Where(f => f.Estado == "Pagada"),
            "pendientes" => facturas.Where(f => f.Estado == "Pendiente" || f.Estado == "Vencida"),
            _ => facturas
        };
    }

    private decimal GetTotalPendiente() => facturas.Where(f => f.Estado != "Pagada").Sum(f => f.Monto);
    
    private string GetProximoVencimiento()
    {
        var next = facturas.Where(f => f.Estado != "Pagada").OrderBy(f => f.FechaVencimiento).FirstOrDefault();
        return next?.FechaVencimiento.ToString("dd MMM") ?? "-";
    }

    private string GetStatusClass(string estado) => estado switch
    {
        "Pagada" => "text-success",
        "Vencida" => "text-danger",
        _ => "text-warning"
    };

    private void DescargarFactura(int id) { /* Download logic */ }

    class FacturaInfo 
    {
        public int Id { get; set; }
        public string Numero { get; set; }
        public string Poliza { get; set; }
        public string Estado { get; set; }
        public decimal Monto { get; set; }
        public DateTime FechaVencimiento { get; set; }
    }
}