@page "/cliente/polizas"
@using Birlik_Mobile.Models.ViewModel
@inject NavigationManager Nav
@inject Birlik_Mobile.Services.AuthService AuthService
@inject Birlik_Mobile.Services.PolizaService PolizaService

<div class="page-container">
    <div class="header-section animate-enter">
        <button class="btn-icon-back" @onclick='() => Nav.NavigateTo("/cliente/dashboard")'>
            <i class="bi bi-chevron-left"></i>
        </button>
        <h1>Mis Pólizas</h1>
    </div>

    <!-- Filter Tabs -->
    <div class="filter-scroll animate-enter" style="animation-delay: 0.1s">
        <button class="filter-pill @(filtroActivo == "todas" ? "active" : "")" 
                @onclick='() => filtroActivo = "todas"'>Todas</button>
        <button class="filter-pill @(filtroActivo == "activas" ? "active" : "")" 
                @onclick='() => filtroActivo = "activas"'>Activas</button>
        <button class="filter-pill @(filtroActivo == "vencidas" ? "active" : "")" 
                @onclick='() => filtroActivo = "vencidas"'>Vencidas</button>
    </div>

    <!-- Policy List -->
    <div class="policy-list animate-enter" style="animation-delay: 0.2s">
        @if (cargando)
        {
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Cargando tus pólizas...</p>
            </div>
        }
        else if (!ObtenerPolizasFiltradas().Any())
        {
            <div class="empty-state">
                <i class="bi bi-folder2-open"></i>
                <p>No hay pólizas en esta categoría</p>
            </div>
        }
        else
        {
            @foreach (var poliza in ObtenerPolizasFiltradas())
            {
                <div class="policy-card glass-panel" @onclick="() => VerDetalle(poliza)">
                    <div class="card-top">
                        <div class="icon-box">
                            <i class="bi bi-shield-check"></i>
                        </div>
                        <div class="status-badge @GetStatusClass(poliza)">
                            @poliza.Estado
                        </div>
                    </div>
                    
                    <div class="card-content">
                        <h3>@poliza.Ramo</h3>
                        <p class="policy-number">#@poliza.Numero</p>
                        <p class="insurer">@poliza.Aseguradora</p>
                    </div>

                    <div class="card-footer">
                        <span class="date-label">Vence: @poliza.Fin.ToString("dd MMM yyyy")</span>
                        <div class="footer-actions">
                            <button class="btn-icon-doc" @onclick="() => VerDocumento(poliza)" @onclick:stopPropagation="true">
                                <i class="bi bi-file-earmark-text"></i>
                            </button>
                            <i class="bi bi-chevron-right arrow-icon"></i>
                        </div>
                    </div>
                </div>
            }
        }
    </div>
</div>
@code {
    private List<PolizaViewModel> polizas = new();
    private string filtroActivo = "todas";
    private bool cargando = true;
    private bool hayError = false;
    private string mensajeError = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await CargarPolizas();
    }

    private async Task CargarPolizas()
    {
        cargando = true;
        hayError = false;
        mensajeError = string.Empty;

        try
        {
            var usuario = await AuthService.ObtenerUsuarioLogueado();

            // ✅ Validación del usuario
            if (usuario == null)
            {
                hayError = true;
                mensajeError = "No se pudo obtener la información del usuario";
                Console.WriteLine("❌ Usuario no logueado");
                Nav.NavigateTo("/login");
                return;
            }

            // ✅ Validación del IdCliente
            if (usuario.IdCliente <= 0)
            {
                hayError = true;
                mensajeError = "Usuario sin cliente asignado. Contacte al administrador.";
                Console.WriteLine($"⚠️ Usuario {usuario.Correo} no tiene IdCliente válido: {usuario.IdCliente}");
                return;
            }

            Console.WriteLine($"📋 Cargando pólizas para IdCliente: {usuario.IdCliente}");

            // ✅ Usa IdCliente en lugar de Id
            polizas = await PolizaService.ObtenerPolizasClienteAsync(usuario.IdCliente);

            if (polizas == null || !polizas.Any())
            {
                Console.WriteLine($"⚠️ No se encontraron pólizas para IdCliente: {usuario.IdCliente}");
                polizas = new List<PolizaViewModel>();
            }
            else
            {
                Console.WriteLine($"✅ Se cargaron {polizas.Count} pólizas");
            }

            // Lógica de estados simplificada
            foreach (var p in polizas)
            {
                if (!p.EsActivo || p.DiasParaVencer <= 0)
                    p.Estado = "Vencida";
                else if (p.DiasParaVencer <= 30)
                    p.Estado = "Por Vencer";
                else
                    p.Estado = "Activa";
            }
        }
        catch (Exception ex)
        {
            hayError = true;
            mensajeError = "Error al cargar las pólizas. Intente nuevamente.";
            Console.WriteLine($"❌ Error en CargarPolizas: {ex.Message}");
            polizas = new List<PolizaViewModel>();
        }
        finally
        {
            cargando = false;
            StateHasChanged();
        }
    }

    private List<PolizaViewModel> ObtenerPolizasFiltradas()
    {
        return filtroActivo switch
        {
            "activas" => polizas.Where(p => p.Estado == "Activa" || p.Estado == "Por Vencer").ToList(),
            "vencidas" => polizas.Where(p => p.Estado == "Vencida").ToList(),
            _ => polizas
        };
    }

    private string GetStatusClass(PolizaViewModel p)
    {
        return p.Estado switch
        {
            "Activa" => "success",
            "Por Vencer" => "warning",
            _ => "danger"
        };
    }

    private void VerDetalle(PolizaViewModel p) => Nav.NavigateTo($"/cliente/poliza/{p.Id}");

    private void VerDocumento(PolizaViewModel p)
    {
        if (!string.IsNullOrWhiteSpace(p.Documento))
        {
            Nav.NavigateTo(p.Documento, true);
        }
        else
        {
            Console.WriteLine("⚠️ No existe documento para esta póliza.");
        }
    }
}