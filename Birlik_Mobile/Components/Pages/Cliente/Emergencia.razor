@page "/cliente/emergencia"
@inject NavigationManager Nav

<div class="emergencia-container">
    <!-- Header de emergencia -->
    <div class="emergency-header">
        <button class="back-btn" @onclick="@(() => Nav.NavigateTo("/cliente/dashboard"))">
            <i class="bi bi-arrow-left"></i>
        </button>
        <h1 class="page-title">Emergencia</h1>
        <button class="sos-btn" @onclick="ActivarSOS">
            <i class="bi bi-telephone"></i>
        </button>
    </div>

    <!-- Botón SOS principal -->
    <div class="sos-main-section">
        <div class="sos-card">
            <div class="sos-icon">
                <i class="bi bi-exclamation-triangle"></i>
            </div>
            <h2 class="sos-title">¿Necesitas ayuda inmediata?</h2>
            <p class="sos-description">Presiona el botón de emergencia para contactar a nuestros especialistas</p>
            
            <button class="sos-main-btn @(isSOSActive ? "active" : "")" @onclick="ActivarSOS">
                <i class="bi bi-telephone-fill"></i>
                <span>@(isSOSActive ? "Llamando..." : "SOS EMERGENCIA")</span>
            </button>
        </div>
    </div>

    <!-- Opciones de contacto -->
    <div class="contact-options">
        <h3 class="section-title">
            <i class="bi bi-telephone me-2"></i>
            Opciones de Contacto
        </h3>
        
        <div class="contact-grid">
            <button class="contact-btn emergency" @onclick="LlamarEmergencia">
                <div class="contact-icon">
                    <i class="bi bi-telephone-fill"></i>
                </div>
                <div class="contact-info">
                    <h4>Emergencia 24/7</h4>
                    <p>911</p>
                </div>
            </button>

            <button class="contact-btn support" @onclick="LlamarSoporte">
                <div class="contact-icon">
                    <i class="bi bi-headset"></i>
                </div>
                <div class="contact-info">
                    <h4>Soporte Birlik</h4>
                    <p>+506 2222-2222</p>
                </div>
            </button>

            <button class="contact-btn whatsapp" @onclick="AbrirWhatsApp">
                <div class="contact-icon">
                    <i class="bi bi-whatsapp"></i>
                </div>
                <div class="contact-info">
                    <h4>WhatsApp</h4>
                    <p>+506 8888-8888</p>
                </div>
            </button>

            <button class="contact-btn email" @onclick="EnviarEmail">
                <div class="contact-icon">
                    <i class="bi bi-envelope"></i>
                </div>
                <div class="contact-info">
                    <h4>Email</h4>
                    <p>emergencias@birlik.com</p>
                </div>
            </button>
        </div>
    </div>

    <!-- Comisarías cercanas -->
    <div class="comisarias-section">
        <h3 class="section-title">
            <i class="bi bi-geo-alt me-2"></i>
            Comisarías Cercanas
        </h3>
        
        <div class="map-container">
            <!-- Placeholder para el mapa de Google -->
            <div class="map-placeholder" @onclick="AbrirMapaCompleto">
                <div class="map-content">
                    <i class="bi bi-geo-alt-fill"></i>
                    <h4>Ver en Mapa</h4>
                    <p>Toque para abrir Google Maps con las comisarías más cercanas</p>
                    <button class="map-btn">
                        <i class="bi bi-arrow-up-right"></i>
                        Abrir Mapa
                    </button>
                </div>
            </div>
        </div>

        <!-- Lista de comisarías -->
        <div class="comisarias-list">
            @foreach (var comisaria in GetComisariasCercanas())
            {
                <div class="comisaria-card" @onclick="@(() => AbrirDireccion(comisaria.Direccion))">
                    <div class="comisaria-icon">
                        <i class="bi bi-shield-check"></i>
                    </div>
                    <div class="comisaria-info">
                        <h4 class="comisaria-nombre">@comisaria.Nombre</h4>
                        <p class="comisaria-direccion">@comisaria.Direccion</p>
                        <p class="comisaria-distancia">@comisaria.Distancia km</p>
                    </div>
                    <div class="comisaria-actions">
                        <button class="action-btn" @onclick="@(() => LlamarComisaria(comisaria.Telefono))" @onclick:stopPropagation="true">
                            <i class="bi bi-telephone"></i>
                        </button>
                        <button class="action-btn" @onclick="@(() => AbrirDireccion(comisaria.Direccion))" @onclick:stopPropagation="true">
                            <i class="bi bi-navigation"></i>
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Información de emergencia -->
    <div class="emergency-info">
        <div class="info-card">
            <div class="info-icon">
                <i class="bi bi-info-circle"></i>
            </div>
            <div class="info-content">
                <h4>Información Importante</h4>
                <ul>
                    <li>En caso de emergencia médica, llame al 911</li>
                    <li>Para siniestros de seguros, contacte a Birlik</li>
                    <li>Mantenga sus datos personales actualizados</li>
                    <li>Guarde este número en sus contactos de emergencia</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Estado de llamada -->
    @if (isSOSActive)
    {
        <div class="sos-overlay">
            <div class="sos-modal">
                <div class="sos-modal-content">
                    <div class="sos-modal-icon">
                        <i class="bi bi-telephone-fill"></i>
                    </div>
                    <h3>Conectando con Emergencias...</h3>
                    <p>Por favor espere mientras conectamos su llamada</p>
                    <div class="sos-timer">@GetTiempoTranscurrido()</div>
                    <button class="sos-cancel-btn" @onclick="CancelarSOS">
                        <i class="bi bi-x-lg"></i>
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool isSOSActive = false;
    private DateTime sosStartTime;
    private Timer? sosTimer;

    private List<ComisariaInfo> comisarias = new()
    {
        new ComisariaInfo
        {
            Nombre = "Comisaría Central",
            Direccion = "Av. Central, San José",
            Telefono = "2222-0000",
            Distancia = 0.8
        },
        new ComisariaInfo
        {
            Nombre = "Comisaría La Sabana",
            Direccion = "Paseo Colón, San José",
            Telefono = "2222-0001",
            Distancia = 1.2
        },
        new ComisariaInfo
        {
            Nombre = "Comisaría Hatillo",
            Direccion = "Hatillo Centro, San José",
            Telefono = "2222-0002",
            Distancia = 2.5
        }
    };

    private IEnumerable<ComisariaInfo> GetComisariasCercanas()
    {
        return comisarias.OrderBy(c => c.Distancia);
    }

    private void ActivarSOS()
    {
        if (isSOSActive)
        {
            CancelarSOS();
            return;
        }

        isSOSActive = true;
        sosStartTime = DateTime.Now;
        
        sosTimer = new Timer(UpdateTimer, null, 0, 1000);
        
        StateHasChanged();
    }

    private void CancelarSOS()
    {
        isSOSActive = false;
        sosTimer?.Dispose();
        sosTimer = null;
        StateHasChanged();
    }

    private void UpdateTimer(object? state)
    {
        InvokeAsync(StateHasChanged);
    }

    private string GetTiempoTranscurrido()
    {
        if (!isSOSActive) return "00:00";
        
        var elapsed = DateTime.Now - sosStartTime;
        return $"{elapsed.Minutes:D2}:{elapsed.Seconds:D2}";
    }

    private void LlamarEmergencia()
    {
        // TODO: Implementar llamada a 911
        ShowMessage("Llamando a emergencias 911...");
    }

    private void LlamarSoporte()
    {
        // TODO: Implementar llamada a soporte
        ShowMessage("Llamando a soporte Birlik...");
    }

    private void AbrirWhatsApp()
    {
        // TODO: Implementar apertura de WhatsApp
        ShowMessage("Abriendo WhatsApp...");
    }

    private void EnviarEmail()
    {
        // TODO: Implementar envío de email
        ShowMessage("Abriendo cliente de email...");
    }

    private void AbrirMapaCompleto()
    {
        // TODO: Implementar apertura de Google Maps
        ShowMessage("Abriendo Google Maps...");
    }

    private void LlamarComisaria(string telefono)
    {
        ShowMessage($"Llamando a {telefono}...");
    }

    private void AbrirDireccion(string direccion)
    {
        ShowMessage($"Abriendo navegación hacia: {direccion}");
    }

    private void ShowMessage(string message)
    {
        // TODO: Implementar sistema de notificaciones
        Console.WriteLine(message);
    }

    private class ComisariaInfo
    {
        public string Nombre { get; set; } = string.Empty;
        public string Direccion { get; set; } = string.Empty;
        public string Telefono { get; set; } = string.Empty;
        public double Distancia { get; set; }
    }

    public void Dispose()
    {
        sosTimer?.Dispose();
    }
}