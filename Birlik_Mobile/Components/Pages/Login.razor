@page "/"
@page "/login"
@inject Birlik_Mobile.Services.ApiService ApiService
@inject Birlik_Mobile.Services.AuthService AuthService
@inject NavigationManager NavManager

<div class="login-screen">
    <div class="login-header animate-enter" style="animation-delay: 0.1s">
        <div class="logo-container">
            <img src="https://plataformabirlik.azurewebsites.net/Theme/Front-v2-1/dist/assets/imagen/presentacion/logobi_n.svg"
                 alt="Birlik" class="logo-img" />
        </div>
        <h1>Bienvenido</h1>
        <p>Tu tranquilidad, nuestra prioridad.</p>
    </div>

    <div class="login-body animate-enter" style="animation-delay: 0.2s">
        <form @onsubmit="IniciarSesion" @onsubmit:preventDefault="true">
            <div class="form-group">
                <label>Correo Electrónico</label>
                <input type="text" 
                       class="input-modern" 
                       placeholder="nombre@ejemplo.com"
                       @bind="usuario" 
                       @bind:event="oninput" />
            </div>

            <div class="form-group">
                <label>Contraseña</label>
                <input type="password" 
                       class="input-modern" 
                       placeholder="••••••••"
                       @bind="password" 
                       @bind:event="oninput" />
            </div>

            @if (!string.IsNullOrEmpty(mensaje))
            {
                <div class="alert-box @(hasError ? "error" : "success")">
                    @mensaje
                </div>
            }

            <div class="actions">
                <button type="submit" class="btn-primary" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span class="spinner"></span>
                    }
                    else
                    {
                        <span>Iniciar Sesión</span>
                        <i class="bi bi-arrow-right"></i>
                    }
                </button>
            </div>
        </form>

        <div class="login-footer">
            <a href="#" class="link-muted">¿Olvidaste tu contraseña?</a>
        </div>
    </div>
</div>

@code {
    private string usuario = string.Empty;
    private string password = string.Empty;
    private string mensaje = string.Empty;
    private bool isLoading = false;
    private bool hasError = false;

    private async Task IniciarSesion()
    {
        if (string.IsNullOrWhiteSpace(usuario) || string.IsNullOrWhiteSpace(password))
        {
            mensaje = "Por favor completa todos los campos";
            hasError = true;
            return;
        }

        isLoading = true;
        mensaje = string.Empty;
        hasError = false;
        StateHasChanged();

        try
        {
            var request = new Birlik_Mobile.Models.Request.LoginRequestDTO
            {
                Correo = usuario.Trim(),
                PasswordHash = password
            };

            var result = await ApiService.LoginAsync(request);

            if (!result.IsSuccess || result.Data == null)
            {
                mensaje = "Credenciales incorrectas";
                hasError = true;
                isLoading = false;
                StateHasChanged();
                return;
            }

            // ✅ Acceso directo a las propiedades del LoginResponseDTO
            var data = result.Data;

            var usuarioInfo = new Models.Auth.UsuarioInfoDTO
            {
                Id = data.Id,  // Necesitarás esto de la API
                Correo = data.Correo,
                Nombre = data.Nombre,
                Rol = data.Rol,
                IdCliente = data.IdCliente
            };

            await AuthService.SetUserAsync(usuarioInfo, data.Token);

            switch (data.Rol)
            {
                case "Cliente":
                    NavManager.NavigateTo("/cliente/dashboard", forceLoad: true);
                    break;
                case "Ejecutivo":
                    NavManager.NavigateTo("/ejecutivo/dashboard", forceLoad: true);
                    break;
                case "Gerente":
                    NavManager.NavigateTo("/gerente/dashboard", forceLoad: true);
                    break;
                default:
                    NavManager.NavigateTo("/home", forceLoad: true);
                    break;
            }
        }
        catch (Exception ex)
        {
            isLoading = false;
            hasError = true;
            mensaje = "Error de conexión";
            Console.WriteLine($"❌ Error en login: {ex.Message}");
            StateHasChanged();
        }
    }
}